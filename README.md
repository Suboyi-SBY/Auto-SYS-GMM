# 📊 Stata System GMM Lag Combinations Automation 

> 这个项目是我一边研究一边自学 Stata 编程时写的小工具，用来在跑系统 GMM（System GMM）的时候，**自动帮我找出一组“还凑合”的滞后期组合**，避免我手动改 `lag(2 3)` 改到眼花 。
> > ✍️ **免责声明**：我自己水平很菜，代码写得也不优雅，可能有不少 bug 和逻辑漏洞。如果你是大佬路过，看到什么错误欢迎指正。

## 🧠 背景说明

做系统 GMM（System GMM）的时候，滞后期设置很关键。但手动试各种组合不仅累，还容易漏。这个脚本可以自动：

1. **枚举各种滞后期组合**（三组变量，各自设定滞后范围）
2. **跑 xtabond2 回归**
3. **记录关键统计量**（AR(1), AR(2), Hansen, Sargan 等）
4. **筛选满足诊断标准的组合**
5. **输出最优组合和对应命令**
6. **把结果保存为 Excel 表格**

---

## 🧰 使用环境

- **Stata 18+**（应该低版本也可以）
- 必须安装好 [`xtabond2`]命令

---

## 📦 脚本文件

脚本名称：`Automatically calculate SYS-GMM.do`

你需要根据自己数据和变量设置，**修改脚本前面几部分的内容**（代码中有注释！）

---

## 📝 脚本结构说明

### 1️⃣ 设置滞后期范围

```stata
global lag_start 1
global lag_end 3
例如：会尝试 1~3 阶滞后，共 3×3×3 组组合。
```
### 2️⃣ 设置数据路径
```stata
local datafile "你的数据路径.dta"
local outfile "输出Excel路径.xlsx"
```
### 3️⃣ 变量设置
```stata
local var_main 被解释变量 L.被解释变量 解释变量 控制变量（内生+外生）
local var_gmm1 L.被解释变量       // 前定变量1（一般是L.Y）
local var_gmm2 解释变量            // 前定变量2
local var_gmm3 内生控制变量        // 控制变量中怀疑有内生性的部分
local var_iv 外生控制变量          // 完全外生的变量
```
### 4️⃣ 自动循环回归
脚本会尝试每组滞后组合，存下来的有：

-   系数 (`coef`)
    
-   P值 (`pval`)
    
-   AR(1), AR(2)
    
-   Hansen 检验, Sargan 检验

👉 建议先用小样本测一下，暴力跑全部组合有点慢！

### 5️⃣ 自动筛选最优组合
筛选逻辑如下：
```stata
gen valid = (pval < 0.05 & ar1p < 0.1 & ar2p > 0.1 & hansenp > 0.1)
```
你可以改成自己想要的标准。

### 6️⃣ 自动输出结果

-   所有组合的结果会保存为 Excel 文件
    
-   会打印并运行“最优组合”的 xtabond2 命令
    
## ⚠️ 已知/可能存在的问题

-   💥 写得很乱，变量设置必须自己改清楚（变量分类要自己改对，不然回归结果没意义。）
    
-   🥴 忘记 collapse 会让 instrument 爆表（使用 collapse 会极大地减少 instrument 数量；是否加 collapse 你自己判断，我也不知道对不对。）
    
-   😭 如果变量名打错，代码不会告诉你哪里错了（只能自己 debug）
    
-   🪤 `L.` 滞后标签不要乱用，Stata 不会提醒你逻辑错
    
-   📉 有些组合会报错跳过，这个是正常的

## ❤️ 鸣谢

本代码在写论文的时候开发，用于处理系统 GMM 的滞后组合问题。感谢 GPT 给我的灵感
## 🧾 License

随便用，但请注明出处（如果你愿意）。别用来骗项目经费就行 😅。
## 免责声明
请在清醒、备份的状态下使用本脚本，所有模型结果请自行判断合理性。本人不承担任何学术事故的责任（真的我很怕）😂。
